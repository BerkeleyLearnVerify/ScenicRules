"""
TITLE: cruise_07212023-a-pdf
DESCRIPTION: A Cruise autonomous vehicle ("Cruise AV"), operating in driverless autonomous mode, was traveling eastbound on McAllister Street between Van Ness Avenue and Polk Street. As the Cruise AV was slowing for a red light at the intersection with Polk Street, an Infiniti Q60 traveling westbound on McAllister Street failed to stop for the red light, entered the intersection, and made contact with a black sedan traveling southbound on Polk Street that entered the intersection on a green light. The Infiniti Q60 spun after contact and continued into the Cruise AV, damaging the front bumper fascia of the Cruise AV. The driver of the Infiniti Q60 was transported by police. There were no reported injuries and both the Infiniti Q60 and the black sedan were towed from the scene.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

CRUISE_AV_MODEL = 'vehicle.lincoln.mkz_2017'
INFINITI_MODEL = 'vehicle.tesla.model3'
BLACK_SEDAN_MODEL = 'vehicle.mercedes.c_class'

param CRUISE_AV_SPEED = VerifaiRange(7, 10)

param CRUISE_AV_BRAKE = VerifaiRange(0.5, 1.0)

CRUISE_AV_INIT_DIST_TO_INTERSECTION = 25

param CRUISE_AV_SLOWING_POINT_DIST = 15

param INFINITI_SPEED = 20
INFINITI_INIT_DIST_TO_INTERSECTION = 15

param BLACK_SEDAN_SPEED = 20
BLACK_SEDAN_INIT_DIST_TO_INTERSECTION = 20

param SAFETY_DIST = VerifaiRange(3, 5)
param CRASH_DIST = VerifaiRange(5, 6)


#################################
# AGENT BEHAVIORS               #
#################################

behavior LosingControlBehavior():
    while True:
        take SetSteerAction(0.8)
        take SetThrottleAction(1)

behavior CruiseAVBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.CRUISE_AV_SPEED, trajectory=trajectory) \
            until (distance to intersection) < globalParameters.CRUISE_AV_SLOWING_POINT_DIST
        do FollowTrajectoryBehavior(target_speed=0, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.CRUISE_AV_BRAKE)


behavior InfinitiQ60Behavior(trajectory):
    do FollowTrajectoryBehavior(target_speed=globalParameters.INFINITI_SPEED, trajectory=trajectory) until withinDistanceToAnyObjs(self, globalParameters.CRASH_DIST)
    do LosingControlBehavior()

behavior BlackSedanBehavior(trajectory):
    do FollowTrajectoryBehavior(target_speed=globalParameters.BLACK_SEDAN_SPEED, trajectory=trajectory)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way and len(i.incomingLanes) == 4, network.intersections))

cruiseAvInitLane = Uniform(*intersection.incomingLanes)
cruiseAvManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, cruiseAvInitLane.maneuvers))
cruiseAvTrajectory = [cruiseAvInitLane, cruiseAvManeuver.connectingLane, cruiseAvManeuver.endLane]
cruiseAvSpawnPt = new OrientedPoint in cruiseAvInitLane.centerline

infinitiInitLane = cruiseAvManeuver.reverseManeuvers[0].startLane

infinitiManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, infinitiInitLane.maneuvers))
infinitiTrajectory = [infinitiInitLane, infinitiManeuver.connectingLane, infinitiManeuver.endLane]
infinitiSpawnPt = new OrientedPoint in infinitiInitLane.centerline
infinitiRightManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, infinitiInitLane.maneuvers))

blackSedanInitLane = infinitiRightManeuver.reverseManeuvers[0].startLane
blackSedanManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, blackSedanInitLane.maneuvers))
blackSedanTrajectory = [blackSedanInitLane, blackSedanManeuver.connectingLane, blackSedanManeuver.endLane]
blackSedanSpawnPt = new OrientedPoint in blackSedanInitLane.centerline

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at cruiseAvSpawnPt,
        with blueprint CRUISE_AV_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(cruiseAvTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at cruiseAvSpawnPt,
        with blueprint CRUISE_AV_MODEL,
        with behavior CruiseAVBehavior(cruiseAvTrajectory)

infiniti = new Car at infinitiSpawnPt,
    with blueprint INFINITI_MODEL,
    with behavior InfinitiQ60Behavior(infinitiTrajectory)


blackSedan = new Car at blackSedanSpawnPt,
    with blueprint BLACK_SEDAN_MODEL,
    with behavior BlackSedanBehavior(blackSedanTrajectory)

#################################
# REQUIREMENTS                  #
#################################

require CRUISE_AV_INIT_DIST_TO_INTERSECTION - 5 <= (distance from ego to intersection) <= CRUISE_AV_INIT_DIST_TO_INTERSECTION
require INFINITI_INIT_DIST_TO_INTERSECTION - 5 <= (distance from infiniti to intersection) <= INFINITI_INIT_DIST_TO_INTERSECTION
require BLACK_SEDAN_INIT_DIST_TO_INTERSECTION - 5 <=(distance from blackSedan to intersection) <= BLACK_SEDAN_INIT_DIST_TO_INTERSECTION

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in cruiseAvTrajectory[-1] as egoReachedGoal
