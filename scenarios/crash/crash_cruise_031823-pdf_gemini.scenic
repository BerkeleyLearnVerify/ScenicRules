"""
TITLE: cruise_031823-pdf
DESCRIPTION: A Cruise autonomous vehicle ("Cruise AV"), operating in driverless autonomous mode, was traveling southbound on 25th Avenue between Clement Street and Geary Boulevard. The Cruise AV entered the intersection with Geary Boulevard on a green light. As the Cruise AV was passing through the intersection, a Mercedes Sedan traveling eastbound on Geary Boulevard entered the intersection on a red light and shortly thereafter made contact with the Cruise AV, damaging the front right quarter of the Cruise AV. The Mercedes Sedan then made contact with a nearby building, resulting in damage to the property. Police and Emergency Medical Services were called to the scene. The Cruise AV was towed from the scene. Occupants of the Mercedes Sedan received medical treatment at the scene and were not transported by Emergency Medical Services.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

CRUISE_AV_MODEL = 'vehicle.lincoln.mkz_2017'
MERCEDES_MODEL = 'vehicle.mercedes.c_class_2017'

param CRUISE_AV_SPEED = VerifaiRange(8, 12)
param MERCEDES_SPEED = VerifaiRange(30, 40)
param WAYMO_BRAKE = VerifaiRange(0.5, 1.0)
param SAFETY_DIST = VerifaiRange(3, 5)

EGO_INIT_DIST_RANGE = [20, 30]
ADV_INIT_DIST_RANGE = [25, 35]

CRASH_DIST = 2
TERM_DIST = 70

#################################
# AGENT BEHAVIORS               #
#################################

behavior CruiseAVBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.CRUISE_AV_SPEED, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.WAYMO_BRAKE)


behavior MercedesBehavior(trajectory):
    do FollowTrajectoryBehavior(target_speed=globalParameters.MERCEDES_SPEED, trajectory=trajectory)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

egoInitLane = Uniform(*intersection.incomingLanes)
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

egoRightManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, egoInitLane.maneuvers))
print(egoRightManeuver is None)
rightLaneOpposite = egoRightManeuver.endLane.group.opposite
advInitLane = Uniform(*rightLaneOpposite.lanes)
advManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, advInitLane.maneuvers))
advTrajectory = [advInitLane, advManeuver.connectingLane, advManeuver.endLane]
advSpawnPt = new OrientedPoint in advInitLane.centerline

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint CRUISE_AV_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint CRUISE_AV_MODEL,
        with behavior CruiseAVBehavior(egoTrajectory)

mercedes_sedan = new Car at advSpawnPt,
    with blueprint MERCEDES_MODEL,
    with behavior MercedesBehavior(advTrajectory)

require EGO_INIT_DIST_RANGE[0] <= (distance to intersection) <= EGO_INIT_DIST_RANGE[1]
require ADV_INIT_DIST_RANGE[0] <= (distance from mercedes_sedan to intersection) <= ADV_INIT_DIST_RANGE[1]

#terminate when (distance to mercedes_sedan) < CRASH_DIST
#terminate when (distance to egoSpawnPt) > TERM_DIST or (distance from mercedes_sedan to advSpawnPt) > TERM_DIST

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoManeuver.endLane as egoReachedGoal