"""
TITLE: zoox_05112021-pdf
DESCRIPTION: A Zoox vehicle in autonomous mode began to slow down during an unprotected left turn to yield for cross traffic entering the lane from the right. A passenger vehicle from behind did not slow and made contact with the rear sensors of the Zoox vehicle. There were no injuries and the police were not called.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

ZOX_MODEL = 'vehicle.lincoln.mkz_2017'
PASSENGER_MODEL = 'vehicle.toyota.prius'
CROSS_TRAFFIC_MODEL = 'vehicle.mercedes.sprinter'

ZOX_INIT_DIST = [15, 20]
param ZOX_SPEED = VerifaiRange(5, 7) 
param ZOX_BRAKE = VerifaiRange(0.5, 1.0)

param PASSENGER_SPEED = VerifaiRange(7, 9) 
param PASSENGER_FOLLOW_DIST = VerifaiRange(-15, -25) 

CROSS_TRAFFIC_INIT_DIST = [15, 20]
param CROSS_TRAFFIC_SPEED = VerifaiRange(7, 10)

param TURN_YIELD_DIST = VerifaiRange(3, 5) 
param SAFETY_DIST = VerifaiRange(3, 5)
CRASH_DIST = 5
TERM_DIST = 70

ZOOX_DIST_TO_INTERSECTION = [15, 25]
CROSS_DIST_TO_INTERSECTION = [20, 30]

#################################
# AGENT BEHAVIORS               #
#################################

behavior YieldBehavior(brake):
    while True:
        take SetBrakeAction(brake)
        take SetThrottleAction(0)
    
behavior ZooxBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.ZOX_SPEED, trajectory=trajectory) until distance to intersection < globalParameters.TURN_YIELD_DIST
        do YieldBehavior(globalParameters.ZOX_BRAKE)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.ZOX_BRAKE)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is3Way, network.intersections))
zooxInitLane = Uniform(*filter(lambda l: any([m.type is ManeuverType.LEFT_TURN for m in l.maneuvers]) and all([m.type is not ManeuverType.STRAIGHT for m in l.maneuvers]), intersection.incomingLanes))
zooxManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, intersection.maneuvers))

zooxTrajectory = [zooxInitLane, zooxManeuver.connectingLane, zooxManeuver.endLane]
zooxSpawnPt = new OrientedPoint in zooxInitLane.centerline

passengerSpawnPt = new OrientedPoint following roadDirection from zooxSpawnPt for globalParameters.PASSENGER_FOLLOW_DIST

crossTrafficInitLane = Uniform(*filter(lambda l: any([m.type is ManeuverType.STRAIGHT for m in l.maneuvers]) and all([m.type is not ManeuverType.RIGHT_TURN for m in l.maneuvers]) and all([sec._fasterLane is None for sec in l.sections]), intersection.incomingLanes))
crossTrafficManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, crossTrafficInitLane.maneuvers))
crossTrafficSpawnPt = new OrientedPoint in crossTrafficInitLane.centerline

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at zooxSpawnPt,
        with blueprint ZOX_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(zooxTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at zooxSpawnPt,
        with blueprint ZOX_MODEL,
        with behavior ZooxBehavior(zooxTrajectory)

cross_traffic = new Car at crossTrafficSpawnPt,
    with blueprint CROSS_TRAFFIC_MODEL,
    with behavior FollowLaneBehavior(target_speed=globalParameters.CROSS_TRAFFIC_SPEED)

passenger = new Car at passengerSpawnPt,
    with blueprint PASSENGER_MODEL,
    with behavior FollowLaneBehavior(target_speed=globalParameters.PASSENGER_SPEED)

#################################
# REQUIREMENTS                  #
#################################

require ego.lane is passenger.lane
require ZOOX_DIST_TO_INTERSECTION[0] < (distance to intersection) < ZOOX_DIST_TO_INTERSECTION[1]
require CROSS_DIST_TO_INTERSECTION[0] < (distance from cross_traffic to intersection) < CROSS_DIST_TO_INTERSECTION[1]

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in zooxTrajectory[-1] as egoReachedGoal
