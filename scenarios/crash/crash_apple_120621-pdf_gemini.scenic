"""
TITLE: apple_120621-pdf
DESCRIPTION: A test vehicle operating in manual mode was traveling Southeast on El Camino Real in Sunnyvale, and had just crossed Fair Oaks Avenue when a white Lexus RX 350 vehicle pulled out of a parking lot without yielding to oncoming traffic. The driver of the test vehicle braked but was unable to stop before making contact with the front driverâ€™s side of the Lexus. No injuries were reported and law enforcement was not called to the scene.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town05.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

MODEL = 'vehicle.lincoln.mkz_2017' # Used for both ego and adversary for simplicity

param EGO_SPEED = VerifaiRange(8, 12)
param EGO_BRAKE = VerifaiRange(0.6, 1.0)

param ADV_SPEED_INIT = VerifaiRange(1, 3) # Lexus pulling out slowly

param EGO_BRAKE_DIST = VerifaiRange(2, 4)
param CRASH_DIST = VerifaiRange(8, 10)


EGO_DIST_PAST_INTERSECTION = [5, 15] # Ego just crossed the intersection
ADV_DIST_TO_INTERSECTION = [0, 5] # Adversary at or just entering the intersection

TERM_DIST = 70

#################################
# AGENT BEHAVIORS               #
#################################

behavior EgoBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.EGO_SPEED, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.EGO_BRAKE_DIST):
        take SetBrakeAction(globalParameters.EGO_BRAKE)
    #interrupt when withinDistanceToAnyObjs(self, CRASH_DIST):
        #terminate

behavior AdvBehavior():
    while (distance from self to ego) > globalParameters.CRASH_DIST:
        wait
    do LaneChangeBehavior(laneSectionToSwitch=self.laneSection.fasterLane, target_speed=globalParameters.ADV_SPEED_INIT)
    do FollowLaneBehavior(target_speed=globalParameters.ADV_SPEED_INIT)


#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

# Ego is traveling and has just crossed the intersection
egoInitLane = Uniform(*filter(lambda l: all(sec._slowerLane is not None for sec in l.sections), intersection.outgoingLanes))
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

# Adversary pulls out from a parking lot, simulated as turning left from an incoming lane

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    egoTrajectory = [network.laneAt(egoSpawnPt)]
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint MODEL,
        with behavior EgoBehavior(egoTrajectory)

advInitLane=ego.laneSection.slowerLane.lane
advTrajectory = [advInitLane, egoInitLane]
adv_spot = new OrientedPoint on visible advInitLane.centerline

adversary = new Car at adv_spot,
    facing roadDirection,
    with blueprint MODEL, # Using generic MODEL as Lexus blueprint might not be available
    with behavior AdvBehavior()

require distance to intersection < 5
require 10 < distance to adv_spot < 15
#require ADV_DIST_TO_INTERSECTION[0] <= (distance from adversary to intersection) <= ADV_DIST_TO_INTERSECTION[1]
terminate when (distance to egoSpawnPt) > TERM_DIST

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
