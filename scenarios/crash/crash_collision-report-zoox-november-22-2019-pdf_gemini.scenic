"""
TITLE: collision-report-zoox-november-22-2019-pdf
DESCRIPTION: The Zoox vehicle(1) was in conventional mode traveling southbound on Sth Street and making a protected left turn with green arrow onto Folsom Street. The other party's vehicle(2), while being pursued by members of the San Francisco Police Department, illegally entered the intersection from the opposite direction of travel on Sth Street at a high rate of speed and collided with the front/driver's side corner of the Zoox vehicle(1). The force of the impact deployed all front airbags of the Zoox vehicle(1). Both occupants of the Zoox vehicle(1) complained of minor injuries, but declined ambulance transportation.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################
import math
param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

ZOX_MODEL = 'vehicle.toyota.prius'
ADV_MODEL = 'vehicle.lincoln.mkz_2017'

param ZOX_SPEED = VerifaiRange(3.0, 4.0)
param SAFETY_DIST = VerifaiRange(3, 5)
param EGO_BRAKE = VerifaiRange(0.5, 1.0)

ZOX_INIT_DIST = [12, 15]
ADV_INIT_DIST = [40, 60]

COLLISION_THRESHOLD_FACTOR = 0.5
TERM_DIST = 70

#################################
# AGENT BEHAVIORS               #
#################################

behavior ZooxBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.ZOX_SPEED, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.EGO_BRAKE)

behavior AdversaryBehavior(trajectory):
    while True:
        take SetThrottleAction(1.0), SetSteerAction(0.0)
        wait

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

egoInitLane = Uniform(*intersection.incomingLanes)
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

egoStraightManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoStraightEndLane = egoStraightManeuver.endLane
egoStraightOppositeLane = Uniform(*egoStraightEndLane.group._opposite.lanes)

advOppositeManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoStraightOppositeLane.maneuvers))
advInitLane = advOppositeManeuver.endLane
advTrajectory = [advOppositeManeuver.startLane, advOppositeManeuver.connectingLane, advOppositeManeuver.endLane][::-1]
#advTrajectory = [advInitLane, advManeuver.connectingLane, advManeuver.endLane]
#advSpawnPt = new OrientedPoint in advInitLane.centerline

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint ZOX_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint ZOX_MODEL,
        with behavior ZooxBehavior(egoTrajectory)

adversary = new Car in advInitLane.centerline,
    with blueprint ADV_MODEL,
    facing 180 deg relative to roadDirection,
    with behavior AdversaryBehavior(advTrajectory)

startDir = advInitLane.centerline[1] - advInitLane.centerline[0]
endDir = advInitLane.centerline[-1] - advInitLane.centerline[-2]
turnAngle = startDir.angleWith(endDir)

require abs(turnAngle) < math.radians(20)
require ZOX_INIT_DIST[0] <= (distance to intersection) <= ZOX_INIT_DIST[1]
require ADV_INIT_DIST[0] <= (distance from adversary to intersection) <= ADV_INIT_DIST[1]
#terminate when (distance to adversary) < (ego.length + adversary.length) * COLLISION_THRESHOLD_FACTOR
#terminate when (distance to egoSpawnPt) > TERM_DIST

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
