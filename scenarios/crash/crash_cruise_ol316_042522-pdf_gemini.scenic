"""
TITLE: cruise_ol316_042522-pdf
DESCRIPTION: A Cruise autonomous vehicle (“Cruise AV”), operating in driverless autonomous mode, was stopped at a red light on westbound Sacramento Street at the intersection with Van Ness Avenue. The Cruise AV began to proceed straight after the light turned green. At the same time, a silver Hyundai Sedan was traveling the wrong way (eastbound) on a one-way section of Sacramento Street between Franklin Street and Van Ness Avenue. The silver Hyundai Sedan entered the intersection across from the Cruise AV, and the Cruise AV came to a full stop. The silver Hyundai Sedan continued traveling the wrong way through the intersection with Van Ness Avenue and, shortly thereafter, made contact with the Cruise AV, damaging the front fascia assembly and various components on the front of the Cruise AV. The driver of the silver Hyundai Sedan left the scene without exchanging information. The Cruise AV was towed from the scene. There were no injuries and a police report was later filed.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

MODEL = 'vehicle.lincoln.mkz_2017'
ADV_MODEL = 'vehicle.tesla.model3'

param CRUISE_SPEED = VerifaiRange(5, 8)
param CRUISE_BRAKE = VerifaiRange(0.8, 1.0)
param AV_WAIT_TIME = VerifaiDiscreteRange(10, 30)

param HYUNDAI_SPEED = VerifaiRange(8, 12)

EGO_INIT_DIST = [3, 8]
ADV_INIT_DIST = [25, 35]

param NOTICE_DIST = VerifaiRange(20, 30)
param SAFETY_DIST = VerifaiRange(3, 5)
CRASH_DIST = 3
TERM_DIST = 70

#################################
# AGENT BEHAVIORS               #
#################################

behavior CruiseAVBehavior(trajectory):
    try:
        for i in range(globalParameters.AV_WAIT_TIME):
            wait
        do FollowTrajectoryBehavior(target_speed=globalParameters.CRUISE_SPEED, trajectory=trajectory) until withinDistanceToAnyObjs(self, globalParameters.NOTICE_DIST)
        take SetThrottleAction(0.0)
        take SetBrakeAction(1.0)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.CRUISE_BRAKE)


behavior HyundaiBehavior():
    do FollowLaneBehavior(target_speed=globalParameters.HYUNDAI_SPEED, is_oppositeTraffic=True)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

egoInitLane = Uniform(*intersection.incomingLanes)
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]

advInitLane = egoManeuver.endLane

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    behavior EgoPPOBehavior(trajectory):
        for i in range(globalParameters.AV_WAIT_TIME):
            wait
        do MetaDrivePPOPolicyBehavior(trajectory)
    ego = new MetaDrivePPOPolicyCar in egoInitLane,
        with blueprint MODEL,
        with behavior EgoPPOBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car in egoInitLane,
        with blueprint MODEL,
        with behavior CruiseAVBehavior(egoTrajectory)

adversary = new Car in advInitLane,
    facing toward ego,
    with blueprint ADV_MODEL,
    with behavior HyundaiBehavior()

#################################
# REQUIREMENTS                  #
#################################

require EGO_INIT_DIST[0] <= (distance to intersection) <= EGO_INIT_DIST[1]
require ADV_INIT_DIST[0] <= (distance from adversary to intersection) <= ADV_INIT_DIST[1]

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
