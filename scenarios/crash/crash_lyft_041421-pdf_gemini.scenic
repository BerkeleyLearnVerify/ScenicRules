"""
TITLE: lyft_041421-pdf
DESCRIPTION: On April 14, 2021 at 9:38am, AV104 driving in autonomous mode in San Francisco, California, experienced longitudinal contact from a Toyota sedan at the intersection of First and Harrison Streets. The AV was moving at 9mph in the right lane and slowing to begin to execute a right turn, when the Toyota sedan “‘side-swiped” the left front lidar unit on the AV while overtaking at a greater speed from the left adjacent lane. The AV vehicle sustained moderate property damage to the lidar unit, mount, and front fender/bumper. The driver of the Toyota did not stop*. There are no known injuries, and Lyft does not know what (if any) damage was sustained by the Toyota. *Note: this lane merges onto a freeway ramp and may not have provided a place to safely pull over.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town05.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

AV_MODEL = 'vehicle.lincoln.mkz_2017'
TOYOTA_MODEL = 'vehicle.toyota.prius'

param AV_TURN_SPEED = VerifaiRange(1.0, 2.0) # Approximately 9 MPH
param AV_SPEED = VerifaiRange(3.5, 4.5)
param AV_BRAKE = VerifaiRange(0.5, 1.0)
param SAFETY_DIST = VerifaiRange(3.0, 5.0)
param TOYOTA_OVERTAKE_SPEED = VerifaiRange(10, 15) # Approximately 12-15 MPH
param TOYOTA_X_OFFSET = VerifaiRange(1.5, 1.8)
param AV_X_OFFSET = VerifaiRange(-0.5, -1.0)

AV_INIT_DIST_TO_INTERSECTION = [5, 15]

COLLISION_DIST = 1.0
TERM_DIST = 20

#################################
# AGENT BEHAVIORS               #
#################################

behavior AVBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.AV_TURN_SPEED, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.AV_BRAKE)

behavior DriveStraightBehavior():
    while True:
        take SetThrottleAction(1)

behavior ToyotaBehavior():
    do DriveStraightBehavior()

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

avInitLane = Uniform(*filter(lambda l: all([sec._fasterLane is not None for sec in l.sections]), intersection.incomingLanes))
avManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, avInitLane.maneuvers))
avTrajectory = [avInitLane, avManeuver.connectingLane, avManeuver.endLane]
avSpawnPt = new OrientedPoint in avInitLane.centerline

toyotaInitLane = avInitLane.sections[0].fasterLane.lane
toyotaSpawnPt = new OrientedPoint in toyotaInitLane.centerline

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at avSpawnPt,
        with blueprint AV_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(avTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at avSpawnPt,
        with blueprint AV_MODEL,
        with behavior AVBehavior(avTrajectory)

toyota = new Car at (toyotaSpawnPt offset by (globalParameters.TOYOTA_X_OFFSET, 0)),
    with blueprint TOYOTA_MODEL,
    with behavior ToyotaBehavior(),
    facing roadDirection

#################################
# REQUIREMENTS                  #
#################################

require distance to intersection < distance from toyota to intersection
require AV_INIT_DIST_TO_INTERSECTION[0] <= (distance to intersection) <= AV_INIT_DIST_TO_INTERSECTION[1]
require TERM_DIST - 5 < distance from ego to toyota < TERM_DIST

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in avTrajectory[-1] as egoReachedGoal
