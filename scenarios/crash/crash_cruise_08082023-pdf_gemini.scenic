"""
TITLE: cruise_08082023-pdf
DESCRIPTION: A Cruise autonomous vehicle (“AV”), operating in driverless autonomous mode, was traveling northbound on Pennsylvania Avenue between 23rd Street and 25th Street when the AV approached a double-parked semi-trailer truck in the AV's lane of travel. The AV began to maneuver around and to the left of the semi-trailer truck and came to a stop for a stop sign at the intersection with 23rd Street. At the same time, the semi-trailer truck proceeded forward and, shortly thereafter, made contact with the AV. This caused damage to the front passenger side bumper fascia of the AV. The parties exchanged information and there were no reported injuries.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

AV_MODEL = 'vehicle.lincoln.mkz_2017'
TRUCK_MODEL = 'vehicle.volvo.fh16'

param AV_SPEED = VerifaiRange(6, 6.5)
param AV_BRAKE = VerifaiRange(0.5, 1.0)

TRUCK_INITIAL_SPEED = 0.1
param TRUCK_THROTTLE = VerifaiRange(0.5, 1.0)

param TRUCK_INIT_DIST_AHEAD = VerifaiRange(20, 30)
param TRUCK_WAIT_TIME = VerifaiDiscreteRange(30, 50)
param AV_MANEUVER_DIST = VerifaiRange(15, 20)

param BYPASS_INIT_DIST = VerifaiRange(10, 15)
param SAFETY_DIST = VerifaiRange(3, 5)
BYPASS_CLEAR_DIST = 5

param STOP_DIST_THRESHOLD = VerifaiRange(5, 10)

CRASH_DIST = 3
TERM_DIST = 70

#################################
# AGENT BEHAVIORS               #
#################################

behavior StoppingBehavior():
    while True:

        take SetThrottleAction(0)
        take SetBrakeAction(1)
        wait

behavior WaitBehavior():
    while True:
        wait


behavior GoForwardBehavior(throttle):
    while True:
        take SetThrottleAction(throttle)


behavior CruiseAVBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.AV_SPEED, trajectory=trajectory) until withinDistanceToAnyObjs(self, globalParameters.AV_MANEUVER_DIST)
        
        do LaneChangeBehavior(self.laneSection.fasterLane, target_speed=globalParameters.AV_SPEED)

        do FollowLaneBehavior(target_speed=globalParameters.AV_SPEED) for 15 steps

        do LaneChangeBehavior(self.laneSection.slowerLane) for 5 steps

        do StoppingBehavior()
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        #print("Crash occurred")
        take SetBrakeAction(1)

behavior SemiTrailerTruckBehavior(egoVehicle):
    while (distance from self to ego) > globalParameters.STOP_DIST_THRESHOLD:
        wait
    while (distance from self to ego) < globalParameters.STOP_DIST_THRESHOLD:
        for i in range(globalParameters.TRUCK_WAIT_TIME):
            wait
        
        do GoForwardBehavior(throttle=globalParameters.TRUCK_THROTTLE) 
        


#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

egoInitLane = Uniform(*filter(lambda l: all([sec._fasterLane is not None for sec in l.sections]), intersection.incomingLanes))
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

truckSpawnPt = new OrientedPoint following roadDirection from egoSpawnPt for globalParameters.TRUCK_INIT_DIST_AHEAD

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState, MetaDrivePPOFollowLaneBehavior
    behavior EgoPPOBehavior(trajectory):
        do MetaDrivePPOPolicyBehavior(trajectory) until withinDistanceToAnyObjs(self, globalParameters.AV_MANEUVER_DIST)
        do LaneChangeBehavior(self.laneSection.fasterLane, target_speed=globalParameters.AV_SPEED)
        do MetaDrivePPOFollowLaneBehavior() for 15 steps
        do LaneChangeBehavior(self.laneSection.slowerLane) for 5 steps
        do StoppingBehavior()
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint AV_MODEL,
        with behavior EgoPPOBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint AV_MODEL,
        with behavior CruiseAVBehavior(egoTrajectory)

adversary = new Car at truckSpawnPt,
    with blueprint TRUCK_MODEL,
    with behavior SemiTrailerTruckBehavior(ego)

require ego.lane == adversary.lane

from rulebook_benchmark import bench
require monitor bench.bench()
record True as egoReachedGoal