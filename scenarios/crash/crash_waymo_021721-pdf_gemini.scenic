"""
TITLE: waymo_021721-pdf
DESCRIPTION: A Waymo Autonomous Vehicle (“Waymo AV”) was traveling northbound on Shrader Street at Haight Street in San Francisco when it was involved in a collision. While in manual mode, the Waymo AV test driver stopped the Waymo AV at a 4-way stop sign intersection on Shrader Street at Haight Street, signaling to make a left turn. The Waymo AV test driver yielded to a passenger vehicle to their right (facing westbound on Haight Street), allowing the passenger vehicle to enter the intersection before the Waymo AV test driver began to slowly enter the intersection. When the passenger vehicle began to make a left turn in front of the Waymo AV from westbound Haight Street onto southbound Shrader Street, the Waymo AV test driver stopped the Waymo AV. A passenger vehicle behind the Waymo AV then made contact with the stationary Waymo AV’s rear bumper at approximately 7 MPH. The Waymo AV sustained minor damage to its rear bumper, and the passenger vehicle left the scene without exchanging information. No injuries were reported.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

MODEL = "vehicle.toyota.prius"

param EGO_SPEED_ENTERING = VerifaiRange(2.5, 3.5)
param EGO_SLOW_SPEED = VerifaiRange(0.5, 1.5)
param EGO_BRAKE = VerifaiRange(0.5, 1.0)

param FRONT_ADV_SPEED = VerifaiRange(7, 10)
param REAR_ADV_SPEED = VerifaiRange(6.5, 7.5)

param REAR_ADV_DIST = VerifaiRange(-20, -30)
param SAFETY_DIST_EGO_TO_FRONT = VerifaiRange(4, 7)
param SAFETY_DIST = VerifaiRange(3, 5)
param EGO_YIELD_DIST = VerifaiRange(5, 7)

CRASH_DIST = 5
EGO_INIT_POS_DIST_FROM_INTERSECTION = VerifaiRange(5, 15)
FRONT_ADV_INIT_POS_DIST_FROM_INTERSECTION = VerifaiRange(5, 15)

TERM_DIST = 100
TERM_TIME = 15

#################################
# AGENT BEHAVIORS               #
#################################

behavior Stop():
    while True:
        take SetThrottleAction(0.0)
        take SetBrakeAction(1.0)
     
behavior WaymoAVBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.EGO_SPEED_ENTERING, trajectory=trajectory) until (distance to intersection) < globalParameters.EGO_YIELD_DIST
        do FollowTrajectoryBehavior(target_speed=globalParameters.EGO_SLOW_SPEED, trajectory=trajectory) until (distance to frontAdv) < globalParameters.SAFETY_DIST_EGO_TO_FRONT
        do Stop() until (distance to frontAdv) >= globalParameters.SAFETY_DIST_EGO_TO_FRONT
        do FollowTrajectoryBehavior(target_speed=globalParameters.EGO_SLOW_SPEED, trajectory=trajectory)

    # Waymo AV stops again when the front adversary begins its left turn directly in front
    interrupt when (distance to frontAdv) < globalParameters.SAFETY_DIST:
        take SetBrakeAction(globalParameters.EGO_BRAKE)

behavior FrontAdvBehavior(trajectory):
    do FollowTrajectoryBehavior(target_speed=globalParameters.FRONT_ADV_SPEED, trajectory=trajectory)

behavior RearAdvBehavior():
    do FollowLaneBehavior(target_speed=globalParameters.REAR_ADV_SPEED) until (distance from self to ego) < CRASH_DIST
    do Stop()

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

# Ego (Waymo AV): Approaching the intersection, making a left turn
egoInitLane = Uniform(*intersection.incomingLanes)
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, egoInitLane.maneuvers))

egoRightManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, egoInitLane.maneuvers))
egoRightLane = egoRightManeuver.endLane

advRightInitLane = egoRightLane.sections[0].laneToLeft.lane
advRightManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, advRightInitLane.maneuvers))
advRightSpawnPt = new OrientedPoint in advRightInitLane.centerline
advRightTrajectory = [advRightInitLane, advRightManeuver.connectingLane, advRightManeuver.endLane]

egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

# Rear Adversary (Passenger Vehicle): Behind the Waymo AV in the same lane
advRearSpawnPt = new OrientedPoint following roadDirection from egoSpawnPt for globalParameters.REAR_ADV_DIST 

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    behavior EgoPPOBehavior(trajectory):
        do MetaDrivePPOPolicyBehavior(egoTrajectory) until (distance to intersection) < globalParameters.EGO_YIELD_DIST
        do MetaDrivePPOPolicyBehavior(egoTrajectory) until (distance to frontAdv) < globalParameters.SAFETY_DIST_EGO_TO_FRONT
        do Stop() until (distance to frontAdv) >= globalParameters.SAFETY_DIST_EGO_TO_FRONT
        do MetaDrivePPOPolicyBehavior(egoTrajectory)
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint MODEL,
        with behavior EgoPPOBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint MODEL,
        with behavior WaymoAVBehavior(egoTrajectory)

frontAdv = new Car at advRightSpawnPt,
    with blueprint MODEL,
    with behavior FrontAdvBehavior(advRightTrajectory)

rearAdv = new Car at advRearSpawnPt,
    with blueprint MODEL,
    with behavior RearAdvBehavior()

#################################
# REQUIREMENTS                  #
#################################

require rearAdv.lane is ego.lane
require distance from ego to intersection < EGO_INIT_POS_DIST_FROM_INTERSECTION
require distance from frontAdv to intersection < FRONT_ADV_INIT_POS_DIST_FROM_INTERSECTION

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
