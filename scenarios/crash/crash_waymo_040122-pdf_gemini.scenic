"""
TITLE: waymo_040122-pdf
DESCRIPTION: On April 1, 2022 at 2:27 AM PST a Waymo Autonomous Vehicle (“Waymo AV”) operating in San Francisco, California was in a collision involving a passenger vehicle on 19th Avenue at Lincoln Way. The Waymo AV was in autonomous mode and proceeding southbound on 19th Avenue in the rightmost lane, with a passenger vehicle traveling parallel in the left adjacent lane. As the two vehicles approached Lincoln Way, the passenger vehicle cut into the Waymo’s lane and braked before turning right on Lincoln Way. As the passenger vehicle executed the right turn, the Waymo AV test driver transitioned to manual mode, applied the brakes, but made contact with the passenger side rear corner of the passenger vehicle. At the time of the impact, the Waymo AV’s Level 4 ADS was not engaged and a test driver was operating the Waymo AV in manual mode. The other party immediately left the scene of the event. The Waymo AV sustained minor damage.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town05.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

WAYMO_MODEL = 'vehicle.toyota.prius'
PASSENGER_MODEL = 'vehicle.lincoln.mkz_2017'

param WAYMO_SPEED = VerifaiRange(3, 5)
param WAYMO_BRAKE = VerifaiRange(0.5, 1.0)

param PASSENGER_SPEED = VerifaiRange(7, 9)
param PASSENGER_BRAKE = VerifaiRange(0.5, 0.8)
param PASSENGER_TURN_SPEED = VerifaiRange(5, 7)
param SAFETY_DIST = VerifaiRange(3, 5)

param LANE_CHANGE_TRIGGER_DIST = VerifaiRange(5, 7)
INITIAL_DIST_FROM_INTERSECTION = VerifaiRange(30, 40)
DIST = 10

CRASH_DIST = 2
TERM_DIST = 70

#################################
# AGENT BEHAVIORS               #
#################################

behavior WaymoAVBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.WAYMO_SPEED, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.WAYMO_BRAKE)

behavior Stop():
    while True:
        take SetBrakeAction(1.0)
        take SetThrottleAction(0.0)

behavior PassengerBehavior(rightTurnTrajectory):
    do FollowLaneBehavior(target_speed=globalParameters.PASSENGER_SPEED) until (distance from self to ego) < globalParameters.LANE_CHANGE_TRIGGER_DIST
    do FollowLaneBehavior(target_speed=globalParameters.PASSENGER_SPEED + 3) until (distance from self to ego) > globalParameters.LANE_CHANGE_TRIGGER_DIST
    do LaneChangeBehavior(self.laneSection.slowerLane, target_speed=globalParameters.PASSENGER_TURN_SPEED) for 1 seconds
    do Stop() for 1 seconds

    do FollowTrajectoryBehavior(target_speed=globalParameters.PASSENGER_TURN_SPEED, trajectory=rightTurnTrajectory)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

passengerManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, intersection.maneuvers))
waymoInitLane = passengerManeuver.startLane
waymoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, waymoInitLane.maneuvers))
passengerRightTurnTrajectory = [passengerManeuver.startLane, passengerManeuver.connectingLane, passengerManeuver.endLane]
waymoTrajectory = [waymoInitLane, waymoManeuver.connectingLane, waymoManeuver.endLane]
waymoSpawnPt = new OrientedPoint in waymoInitLane.centerline
passengerInitLane = waymoInitLane.sections[0].fasterLane.lane
passengerSpawnPt = new OrientedPoint in passengerInitLane.centerline

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at waymoSpawnPt,
        with blueprint WAYMO_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(waymoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at waymoSpawnPt,
        with blueprint WAYMO_MODEL,
        with behavior WaymoAVBehavior(waymoTrajectory)

adversary = new Car at passengerSpawnPt,
    with blueprint PASSENGER_MODEL,
    with behavior PassengerBehavior(passengerRightTurnTrajectory)

require (distance from ego to intersection) < (distance from adversary to intersection)
require INITIAL_DIST_FROM_INTERSECTION < (distance from ego to intersection) 
require (distance from ego to adversary) < DIST

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in waymoTrajectory[-1] as egoReachedGoal
