"""
TITLE: waymo_082121-pdf
DESCRIPTION: A Waymo Autonomous Vehicle (“Waymo AV”) operating in San Francisco was in a collision involving a vehicle at Scott Street and Sacramento Street. While operating in autonomous mode, the Waymo AV was stopped at a stop sign intersection yielding to a pedestrian in the crosswalk as a passenger vehicle arrived at the intersection from the left. Once the pedestrian cleared the crosswalk, the Waymo AV started to proceed at the same time as the passenger vehicle to the left. The driver of the Waymo AV transitioned into manual mode, bringing the vehicle to a stop and the passenger vehicle behind the AV accelerated into the rear of the Waymo vehicle. The Waymo AV sustained minor damage to the rear bumper.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

MODEL = 'vehicle.lincoln.mkz_2017'
PEDESTRIAN_MODEL = 'vehicle.lincoln.mkz_2017'

# Waymo AV (ego)
param WAYMO_PROCEED_SPEED = VerifaiRange(3, 4) # Approximately 3 MPH
param WAYMO_BRAKE = VerifaiRange(0.5, 1.0)
param WAYMO_PROCEED_TIME = VerifaiRange(1.0, 2.0) # Time Waymo AV proceeds before stopping
param WAYMO_YIELD_DIST = VerifaiRange(10, 13)

# Passenger Vehicle (adversary)
param PASSENGER_INIT_DIST = VerifaiRange(-30, -40) # Starts behind ego
param PASSENGER_INIT_SPEED = VerifaiRange(2, 3) # Starts moving slowly
param PASSENGER_ACCEL_SPEED = VerifaiRange(7.0, 9.0) # Accelerates to approximately 8 MPH


# Pedestrian
param PEDESTRIAN_SPEED = VerifaiRange(2, 2.5) # Walking speed
param PEDESTRIAN_CLEAR_DIST = VerifaiRange(7, 9) # Distance from ego for pedestrian to be considered clear
param SAFETY_DIST = VerifaiRange(3, 5)
# General

CRASH_DIST = 1
INIT_DIST = [10, 15] # Distance to intersection for initial placement
TERM_DIST = 70 # General termination distance if no crash
PED_INTERSECTION_DIST = [0, 10]
EGO_INTERSECTION_DIST = [15, 25]
ADV_INTERSECTION_DIST = [15, 25]

#################################
# AGENT BEHAVIORS               #
#################################

behavior Stop():
    while True:
        take SetBrakeAction(1.0)
        take SetThrottleAction(0.0)

behavior WaymoBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.WAYMO_PROCEED_SPEED, trajectory=trajectory) until (distance to pedestrian) < globalParameters.PEDESTRIAN_CLEAR_DIST
        do Stop() for 2 seconds
        do FollowTrajectoryBehavior(target_speed=globalParameters.WAYMO_PROCEED_SPEED, trajectory=trajectory) until (distance to intersection) == 0 
        do Stop() for 2 seconds
        do FollowTrajectoryBehavior(target_speed=globalParameters.WAYMO_PROCEED_SPEED, trajectory=trajectory) for 1.5 seconds
        do Stop()

    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.WAYMO_BRAKE)

behavior PassengerBehavior(trajectory):
    do FollowTrajectoryBehavior(target_speed=globalParameters.PASSENGER_INIT_SPEED, trajectory=trajectory) until (distance from self to intersection) < 5
    do Stop() for 3 seconds
    do FollowTrajectoryBehavior(target_speed=globalParameters.PASSENGER_ACCEL_SPEED, trajectory=trajectory)

behavior PedestrianBehavior():
    take SetWalkingSpeedAction(globalParameters.PEDESTRIAN_SPEED)



#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

# Waymo AV (ego) setup
egoInitLane = Uniform(*intersection.incomingLanes)
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoLeftManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, egoInitLane.maneuvers))

advLeftInitLane = egoLeftManeuver.endLane.sections[0].laneToLeft.lane
advLeftManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, advLeftInitLane.maneuvers))
advLeftSpawnPt = new OrientedPoint in advLeftInitLane.centerline
advLeftTrajectory = [advLeftInitLane, advLeftManeuver.connectingLane, advLeftManeuver.endLane]

egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

# Passenger Vehicle (adversary) setup - placed behind ego in the same lane
adversarySpawnPt = egoInitLane.centerline[0]
adversaryTrajectory = egoTrajectory # Follows the same path as ego

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    behavior EgoPPOBehavior(trajectory):
        do MetaDrivePPOPolicyBehavior(trajectory) until (distance to pedestrian) < globalParameters.PEDESTRIAN_CLEAR_DIST
        do Stop() for 2 seconds
        do MetaDrivePPOPolicyBehavior(trajectory) until (distance to intersection) == 0 
        do Stop() for 2 seconds
        do MetaDrivePPOPolicyBehavior(trajectory) for 1.5 seconds
        do Stop()
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint MODEL,
        with behavior EgoPPOBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint MODEL,
        with behavior WaymoBehavior(egoTrajectory)

adversary = new Car at adversarySpawnPt,
    with blueprint MODEL,
    with behavior FollowLaneBehavior(target_speed=globalParameters.PASSENGER_INIT_SPEED)

adversaryLeft = new Car at advLeftSpawnPt,
    with blueprint MODEL,
    with behavior PassengerBehavior(advLeftTrajectory)

pedestrian = new Pedestrian in ego.laneGroup.sidewalk,
    with blueprint PEDESTRIAN_MODEL,
    with behavior PedestrianBehavior(),
    facing 90 deg relative to ego

#################################
# REQUIREMENTS                  #
#################################

require adversary.lane is ego.lane
require EGO_INTERSECTION_DIST[0] <= (distance from ego to intersection) <= EGO_INTERSECTION_DIST[1]
require PED_INTERSECTION_DIST[0] <= (distance from pedestrian to intersection) <= PED_INTERSECTION_DIST[1]
require ADV_INTERSECTION_DIST[0] <= (distance from adversaryLeft to intersection) <= ADV_INTERSECTION_DIST[1]

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
