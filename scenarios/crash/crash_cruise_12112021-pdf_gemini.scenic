"""
TITLE: cruise_12112021-pdf
DESCRIPTION: A Cruise autonomous vehicle ("Cruise AV"), operating in supervised autonomous mode, was at a complete stop in response to a red light on northbound Larkin Street at the intersection with Turk Street. The Cruise AV entered the intersection on a green light and continued straight when a cyclist traveling eastbound on Turk Street entered the crosswalk. The Cruise AV braked to the cyclist and, shortly thereafter, another vehicle traveling behind the Cruise AV made contact with the Cruise AV's rear bumper, damaging the rear left bumper. The driver of the other vehicle left the scene without exchanging information. There were no injuries and police were not called.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

MODEL = 'vehicle.lincoln.mkz_2017'
BICYCLE_MODEL = 'vehicle.bh.crossbike'

param CRUISE_AV_SPEED = VerifaiRange(5, 8) # Approx 6-9 MPH
param CRUISE_AV_BRAKE = VerifaiRange(0.5, 1.0)

param ADVERSARY_SPEED = VerifaiRange(7, 9) # Approx 15-20 MPH (8 MPH was reference, so slightly faster for collision)
param ADVERSARY_DIST = VerifaiRange(-15, -25) # Initial distance behind ego

param CYCLIST_SPEED = VerifaiRange(2, 4) # Approx 4-9 MPH


EGO_INIT_DIST_TO_INTERSECTION = 20 # Ego's initial distance to the intersection
param SAFETY_DIST = VerifaiRange(3, 5)
param BIKE_DIST = VerifaiRange(10, 15)
param BIKE_OFFSET_Y = VerifaiRange(20, 40) # Lateral offset for cyclist spawn point
param BIKE_ANGLE = VerifaiRange(1.3, 1.5)
CRASH_DIST = 2 # Distance for ego termination upon collision

TERM_DIST_EGO_TRAVEL = 50 # Scenario termination if ego travels too far

#################################
# AGENT BEHAVIORS               #
#################################

behavior StopBehavior():
    while True:
        take SetBrakeAction(1.0)
    
behavior WaitBehavior():
    while True:
        wait

behavior CruiseAVBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.CRUISE_AV_SPEED, trajectory=trajectory) until withinDistanceToAnyPedestrians(self, globalParameters.BIKE_DIST)
        do StopBehavior()
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.CRUISE_AV_BRAKE)

behavior AdversaryBehavior():
    do FollowLaneBehavior(target_speed=globalParameters.ADVERSARY_SPEED)


behavior CyclingBehavior(speed):
    while True:
        take SetWalkingSpeedAction(speed)


behavior CyclistBehavior():
    do WaitBehavior() until withinDistanceToAnyObjs(self, globalParameters.BIKE_DIST + 7)

    take SetWalkingDirectionAction(self.heading + globalParameters.BIKE_ANGLE)

    do CyclingBehavior(globalParameters.CYCLIST_SPEED)


#################################
# SPATIAL RELATIONS             #
#################################



intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

egoInitLane = Uniform(*intersection.incomingLanes)
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline


# Find a crossing lane for the cyclist



# Place the cyclist at the start of its crossing path, potentially already in the intersection area


#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint MODEL,
        with behavior CruiseAVBehavior(egoTrajectory)

advSpawnPt = new OrientedPoint following roadDirection from ego for globalParameters.ADVERSARY_DIST

adversary = new Car at advSpawnPt,
    with blueprint MODEL,
    with behavior AdversaryBehavior()


cyclist = new Bicycle at (egoSpawnPt offset by (-10, globalParameters.BIKE_OFFSET_Y)),
    facing toward ego,
    with blueprint BICYCLE_MODEL,
    with behavior CyclistBehavior()

#################################
# REQUIREMENTS                  #
#################################

require distance to intersection < EGO_INIT_DIST_TO_INTERSECTION
# Ensure the cyclist is actually crossing the ego's path (not just parallel)

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
