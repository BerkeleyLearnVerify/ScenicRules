"""
TITLE: waymo_010122-pdf
DESCRIPTION: On January 1, 2021 at 2:04 AM PST a Waymo Autonomous Vehicle (“Waymo AV”) operating in San Francisco, California was in a collision involving a passenger vehicle at Marin Street and Kansas Street. While proceeding straight in autonomous mode on westbound Marin Street, a passenger vehicle turned right onto Marin Street from Kansas Street, crossing the center lane line and traveling in the oncoming traffic lane. The driver of the Waymo AV transitioned the system into manual mode and slowed, and moved to the right most edge of the lane. The oncoming passenger vehicle struck the left side of the Waymo AV and immediately proceeded to leave the scene of the collision. At the time of the impact, the Waymo AV’s Level 4 ADS was not engaged and a test driver was operating the Waymo AV in manual mode. The Waymo AV sustained moderate damage to the left front panel and both doors on the left side of the vehicle.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

WAYMO_MODEL = 'vehicle.toyota.prius'
PASSENGER_MODEL = 'vehicle.lincoln.mkz_2017'

param WAYMO_SPEED = VerifaiRange(2.5, 3.5) # Approximately 3 MPH
param WAYMO_BRAKE = VerifaiRange(0.5, 1.0)

param PASSENGER_SPEED = VerifaiRange(7.5, 8.5) # Approximately 8 MPH
param ADV_SWITCH_DIST = VerifaiRange(10, 15) # Distance from ego to switch to oncoming lane

EGO_INIT_DIST = [35, 40] # Distance from intersection for ego
ADV_INIT_DIST = [10, 15] # Distance from intersection for adv

param SAFETY_DIST = VerifaiRange(3, 5) # Distance for Waymo to react (slow down)
CRASH_DIST = 3 # Distance to terminate on collision
TERM_DIST = 50 # Distance for scenario to terminate normally

#################################
# AGENT BEHAVIORS               #
#################################

behavior WaymoBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.WAYMO_SPEED, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.WAYMO_BRAKE)

behavior PassengerBehavior(trajectory):
    do FollowTrajectoryBehavior(target_speed=globalParameters.PASSENGER_SPEED, trajectory=trajectory) until withinDistanceToAnyObjs(self, globalParameters.ADV_SWITCH_DIST)
    do LaneChangeBehavior(laneSectionToSwitch=self.laneSection.laneToLeft, is_oppositeTraffic=True, target_speed=globalParameters.PASSENGER_SPEED)
    do FollowLaneBehavior(target_speed=globalParameters.PASSENGER_SPEED, is_oppositeTraffic=True)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

# Waymo AV: proceeding straight in autonomous mode on westbound Marin Street

advManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, intersection.maneuvers))
advInitLane = advManeuver.startLane
advTrajectory = [advInitLane, advManeuver.connectingLane, advManeuver.endLane]
advSpawnPt = new OrientedPoint in advInitLane.centerline

egoInitLane = advManeuver.endLane.sections[0].laneToLeft.lane
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

# Passenger vehicle: turned right onto Marin Street from Kansas Street,
# crossing the center lane line and traveling in the oncoming traffic lane.
# First, find an incoming lane that can turn right onto the road ego is on.

# Select the right turn maneuver for the adversary

# To model "traveling in the oncoming traffic lane" after turning right,
# the final lane of the adversary's trajectory is set to the opposite lane of where ego ends up.

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint WAYMO_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint WAYMO_MODEL,
        with behavior WaymoBehavior(egoTrajectory)

adversary = new Car at advSpawnPt,
    with blueprint PASSENGER_MODEL,
    with behavior PassengerBehavior(advTrajectory)

#################################
# REQUIREMENTS                  #
#################################

# Ensure initial positions are reasonable relative to the intersection
require EGO_INIT_DIST[0] <= (distance to intersection) <= EGO_INIT_DIST[1]
require ADV_INIT_DIST[0] <= (distance from adversary to intersection) <= ADV_INIT_DIST[1]
# Ensure the "oncoming traffic lane" exists for the adversary's trajectory
#require egoManeuver.endLane.oppositeLane is not None

#terminate when (distance to adversary) < (ego.length + adversary.length) / 2
#terminate when (distance to egoSpawnPt) > TERM_DIST

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
