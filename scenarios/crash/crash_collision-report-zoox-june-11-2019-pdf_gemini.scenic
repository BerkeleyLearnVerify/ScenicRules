"""
TITLE: collision-report-zoox-june-11-2019-pdf
DESCRIPTION: A Zoox vehicle, operating in conventional mode, was coming to a stop at the Grant Ave. and Union St. intersection and traveling less than 2mph, when it was struck on its front bumper by a bicyclist. The Zoox vehicle was traveling northbound on the one-way street when the bicyclist turned left from Union St. onto Grant Ave. and rode into the Zoox vehicle. The bicyclist's left turn caused the bicyclist to travel in the wrong direction on the one-way street. After contact, the cyclist continued traveling southbound (against the one-way) on Grant Ave. despite attempts to get the bicyclist's attention in order to exchange information.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

ZOOX_MODEL = 'vehicle.lincoln.mkz_2017'
BICYCLE_MODEL = 'vehicle.bh.crossbike'

param ZOOX_SPEED = VerifaiRange(0.5, 2)
param ZOOX_BRAKE = VerifaiRange(0.7, 1.0)
param BICYCLE_SPEED = VerifaiRange(2.0 , 3.0)
ZOOX_BRAKE_DIST = 5 # Distance from intersection to start braking

param SAFETY_DIST = VerifaiRange(3, 5)
param EGO_BRAKE = VerifaiRange(0.5, 1.0)
CRASH_DIST = 1 # Distance for collision detection

EGO_INIT_DIST = [10, 15]
BICYCLE_INIT_DIST = [0, 5]
TERM_DIST = 50

#################################
# AGENT BEHAVIORS               #
#################################

behavior ZooxBehavior(trajectory):
    try:
        # Zoox vehicle is coming to a stop at the intersection
        do FollowTrajectoryBehavior(target_speed=globalParameters.ZOOX_SPEED, trajectory=trajectory) \
            until (distance to intersection) < ZOOX_BRAKE_DIST
        take SetBrakeAction(globalParameters.ZOOX_BRAKE)
        #take SetSpeedAction(0) # Attempt to fully stop
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.EGO_BRAKE)

behavior BicycleBehavior():
    steps = 0
    take SetWalkingDirectionAction(self.heading - 1)
    take SetWalkingSpeedAction(globalParameters.BICYCLE_SPEED)
    while steps < 30:
        steps += 1
        take SetWalkingDirectionAction(self.heading + 0.06)
        take SetWalkingSpeedAction(globalParameters.BICYCLE_SPEED)
        wait

    while steps < 100:
        steps += 1
        wait

    #do FollowLaneBehavior(target_speed=globalParameters.BICYCLE_SPEED)
    #do FollowTrajectoryBehavior(target_speed=globalParameters.BICYCLE_SPEED, trajectory=trajectory)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

# Zoox (Ego) vehicle path: Northbound on Grant Ave. (assuming an incoming lane)
egoInitLane = Uniform(*intersection.incomingLanes)
egoStraightManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoStraightManeuver.connectingLane, egoStraightManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

# Bicyclist path: Left turn from Union St. onto Grant Ave. (wrong way)
# Find an incoming lane that is roughly perpendicular to egoInitLane (Union St. for ego's Grant Ave.)
egoRightManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, egoInitLane.maneuvers))
rightManeuverLane = egoRightManeuver.endLane
#bicycleSpawnPt = new OrientedPoint on curb

# Find a left turn maneuver from bicycleInitLane.
# The endLane of this maneuver should lead the bicyclist into the intersection's connecting lane.



# Trajectory for bicyclist continuing "wrong way" southbound on Grant Ave.
# This means following ego's approach lanes in reverse order.
# The cyclist is currently on bicycleManeuver.connectingLane (which is egoManeuver.connectingLane).
# To go "southbound (against the one-way) on Grant Ave", it needs to travel
# backward along egoInitLane and potentially its predecessors.
# We reverse the sequence of lanes that ego would have used to approach the intersection.


#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint ZOOX_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint ZOOX_MODEL,
        with behavior ZooxBehavior(egoTrajectory)

bicycle = new Bicycle in rightManeuverLane.group.sidewalk,
    facing toward ego,
    with blueprint BICYCLE_MODEL,
    with behavior BicycleBehavior()

require EGO_INIT_DIST[0] <= (distance to intersection) <= EGO_INIT_DIST[1]
require BICYCLE_INIT_DIST[0] <= (distance from bicycle to intersection) <= BICYCLE_INIT_DIST[1]
terminate when (distance to egoSpawnPt) > TERM_DIST

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal