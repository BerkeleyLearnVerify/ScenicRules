"""
TITLE: lyft-collision-report-april-11-2019-pdf
DESCRIPTION: On April 11,2019 at approximately 11:31 am, a Lyft Autonomous Vehicle operating in manual mode was involved in an incident with a moving third party vehicle. The incident occurred after making a right turn from Natoma Street and 6th Street in San Francisco, CA. Lyft was proceeding straight in the right lane when the third party vehicle aggressively swerved into the right lane, cutting broadside in front of the Lyft AV, and came to a complete stop, causing unavoidable impact from the Lyft AV at approximately 1 mph. The Lyft AV sustained damage to the front left bumper, fender, and left lidar sensor. The third party vehicle sustained damage to the right rear quarter panel and rear passenger door. Lyft AV operators called 911 due to hostile behavior of the third party driver and emergency vehicles responded to the scene. No injuries were reported by the first responders or the team in the Lyft AV.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town05.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

MODEL = 'vehicle.lincoln.mkz_2017'

param EGO_INITIAL_SPEED = VerifaiRange(4, 5)
param EGO_TURN_SPEED = VerifaiRange(4, 5)
param EGO_BRAKE_DECEL = VerifaiRange(0.5, 1.0)

param ADV_INITIAL_SPEED = VerifaiRange(8, 9)
param ADV_SWERVE_SPEED = VerifaiRange(8, 9)
param ADV_CUT_IN_DIST_TO_EGO = VerifaiRange(4, 5)
param ADV_STOP_DIST_TO_EGO = VerifaiRange(3, 5)

param SAFETY_DIST = VerifaiRange(3, 5)
CRASH_DIST = 5
EGO_INIT_DIST_FROM_INTERSECTION = [5, 15]
ADV_INIT_DIST_FROM_INTERSECTION = [15, 25]
TERM_TIME = 10

#################################
# AGENT BEHAVIORS               #
#################################

behavior Stop():
    while True:
        take SetThrottleAction(0)
        take SetBrakeAction(1.0)

behavior LyftAVBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.EGO_INITIAL_SPEED, trajectory=trajectory, turn_speed=globalParameters.EGO_TURN_SPEED)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.EGO_BRAKE_DECEL)


behavior ThirdPartyVehicleBehavior():

    do FollowLaneBehavior(target_speed=globalParameters.ADV_INITIAL_SPEED) until distance from self to ego < globalParameters.ADV_CUT_IN_DIST_TO_EGO
    do FollowLaneBehavior(target_speed=globalParameters.ADV_SWERVE_SPEED) for 0.5 seconds
    do LaneChangeBehavior(
        laneSectionToSwitch=self.laneSection.slowerLane,
        target_speed=globalParameters.ADV_SWERVE_SPEED)

    do Stop()


#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, intersection.maneuvers))
egoInitLane = egoManeuver.startLane
egoLeftManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, egoInitLane.sections[0].fasterLane.lane.maneuvers))
advInitLane = egoLeftManeuver.endLane.sections[0].laneToLeft.lane
advManeuvers = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, advInitLane.maneuvers))

egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]


egoSpawnPt = new OrientedPoint in egoInitLane.centerline


#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint MODEL,
        with behavior LyftAVBehavior(egoTrajectory)

adversary = new Car in advInitLane.centerline,
    with blueprint MODEL,
    with behavior ThirdPartyVehicleBehavior()

require ADV_INIT_DIST_FROM_INTERSECTION[0] < distance from adversary to intersection < ADV_INIT_DIST_FROM_INTERSECTION[1]
require EGO_INIT_DIST_FROM_INTERSECTION[0] < distance from ego to intersection < EGO_INIT_DIST_FROM_INTERSECTION[1]

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
