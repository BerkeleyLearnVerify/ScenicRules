"""
TITLE: cruise_032721-pdf
DESCRIPTION: A Cruise autonomous vehicle ("Cruise AV"), operating in autonomous mode, was turning from northbound Stanyan St. to westbound on Parnassus Street. As the Cruise AV was starting to turn, a black GMC Denali behind the Cruise AV attempted to overtake the Cruise AV causing the AVTO to disengage from autonomous mode. The GMC Denali made contact with the front driver side bumper of the Cruise AV, which caused minor damage to the front bumper. There were no injuries and police were not called. The driver of the GMC Denali did not stop after the incident and could not be contacted.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

MODEL = 'vehicle.lincoln.mkz_2017'
ADV_MODEL = 'vehicle.ford.f150'

param EGO_SPEED = VerifaiRange(4, 4.5)
param ADV_SPEED = VerifaiRange(8, 12)
param EGO_BRAKE = VerifaiRange(0.5, 1.0)

EGO_INIT_DIST = [15, 25]
param ADV_DIST_BEHIND = VerifaiRange(-8, -15)

param SAFETY_DIST = VerifaiRange(3, 5)
CRASH_DIST = 3
TERM_DIST = 70

#################################
# AGENT BEHAVIORS               #
#################################

behavior EgoBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.EGO_SPEED, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.EGO_BRAKE)

behavior AdversaryBehavior(trajectory):
    do FollowTrajectoryBehavior(target_speed=globalParameters.ADV_SPEED, trajectory=trajectory) until distance from self to ego < 15

    for i in range(17):
        take SetSteerAction(-0.3)
        take SetThrottleAction(1.0)
    for i in range(17):
        take SetSteerAction(0.1)
        take SetThrottleAction(1.0)
    
    while True:
        take SetSteerAction(0.0)
        take SetThrottleAction(1.0)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

egoInitLane = Uniform(*filter(lambda lane: any(m.type is ManeuverType.LEFT_TURN for m in lane.maneuvers),
                                 intersection.incomingLanes))
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint MODEL,
        with behavior EgoBehavior(egoTrajectory)

advInitLane = ego.lane
advManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, advInitLane.maneuvers))
advTrajectory = [advInitLane, advManeuver.connectingLane, advManeuver.endLane]
advSpawnPt = new OrientedPoint following roadDirection from egoSpawnPt for globalParameters.ADV_DIST_BEHIND

adversary = new Car at advSpawnPt,
    with blueprint ADV_MODEL,
    with behavior AdversaryBehavior(advTrajectory)

#################################
# REQUIREMENTS                  #
#################################

startDir = advInitLane.centerline[1] - advInitLane.centerline[0]
endDir = advInitLane.centerline[-1] - advInitLane.centerline[-2]
turnAngle = startDir.angleWith(endDir)

require abs(turnAngle) < math.radians(20)
require EGO_INIT_DIST[0] <= (distance to intersection) <= EGO_INIT_DIST[1]

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
