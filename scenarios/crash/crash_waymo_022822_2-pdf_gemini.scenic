"""
TITLE: waymo_022822_2-pdf
DESCRIPTION: On February 28, 2022 at 1:00 PM PST a Waymo Autonomous Vehicle (“Waymo AV”) operating in San Francisco, California was in a collision involving a passenger vehicle on Polk Street at Jackson Street. While traveling southbound on Polk Street at Jackson Street in autonomous mode, the Waymo AV approached a green light and signaled for a right turn when a pedestrian entered the adjacent crosswalk in accordance with the pedestrian “WALK” signal. As the Waymo AV began to slow, the driver transitioned the system into manual mode. A few seconds later, a passenger vehicle approached from behind and made contact with the rear bumper of the Waymo AV. At the time of the impact, the Waymo AV’s Level 4 ADS was not engaged and a test driver was operating the Waymo AV in manual mode. The Waymo AV sustained minor damage.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

MODEL = "vehicle.toyota.prius"
PASSENGER_MODEL = 'vehicle.lincoln.mkz_2017'
PED_MODEL = "vehicle.bh.crossbike"

param WAYMO_SPEED = VerifaiRange(3, 5)
param WAYMO_TURN_SPEED = VerifaiRange(1, 1.5)
param WAYMO_BRAKE = VerifaiRange(0.5, 1.0)
param WAYMO_SLOW_SPEED = VerifaiRange(0.1, 0.3)

param PED_YIELD_DIST = VerifaiRange(10, 15)
param PASSENGER_SPEED = VerifaiRange(6, 8)
param PASSENGER_DIST_BEHIND = VerifaiRange(-15, -25)

param PED_SPEED = VerifaiRange(1.0, 2.0)
param PED_CROSS_TIME = VerifaiRange(2, 4)

param SAFETY_DIST = VerifaiRange(3, 5)
CRASH_DIST = 1

INIT_DIST_TO_INTERSECTION = [15, 30]
PED_DIST_TO_INTERSECTION = 5
TERM_DIST = 50

#################################
# AGENT BEHAVIORS               #
#################################

behavior Stop():
    while True:
        take SetBrakeAction(1.0)
        take SetThrottleAction(0.0)

behavior WaymoBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.WAYMO_SPEED, turn_speed=globalParameters.WAYMO_TURN_SPEED, trajectory=trajectory) until (distance to pedestrian) < globalParameters.PED_YIELD_DIST
        do FollowTrajectoryBehavior(target_speed=globalParameters.WAYMO_SLOW_SPEED, trajectory=trajectory) until (distance to intersection) == 0
        do Stop()
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.WAYMO_BRAKE)

behavior PassengerBehavior():
    do FollowLaneBehavior(target_speed=globalParameters.PASSENGER_SPEED)

behavior PedestrianBehavior():
    while (distance from self to ego) > globalParameters.PED_YIELD_DIST + 3:
        wait
    take SetWalkingSpeedAction(globalParameters.PED_SPEED)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))
waymoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.RIGHT_TURN, intersection.maneuvers))
waymoInitLane = waymoManeuver.startLane
waymoTrajectory = [waymoInitLane, waymoManeuver.connectingLane, waymoManeuver.endLane]
waymoSpawnPt = new OrientedPoint in waymoInitLane.centerline

passengerSpawnPt = new OrientedPoint following roadDirection from waymoSpawnPt for globalParameters.PASSENGER_DIST_BEHIND

pedLane = waymoManeuver.endLane
pedSidewalk = pedLane.group.sidewalk

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at waymoSpawnPt,
        with blueprint MODEL,
        with behavior MetaDrivePPOPolicyBehavior(waymoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at waymoSpawnPt,
        with blueprint MODEL,
        with behavior WaymoBehavior(waymoTrajectory)

adversary = new Car at passengerSpawnPt,
    with blueprint PASSENGER_MODEL,
    with behavior PassengerBehavior()

pedestrian = new Pedestrian in pedSidewalk,
    with blueprint PED_MODEL,
    facing ego,
    with behavior PedestrianBehavior()

#################################
# REQUIREMENTS                  #
#################################

require INIT_DIST_TO_INTERSECTION[0]< (distance to intersection) < INIT_DIST_TO_INTERSECTION[1]
require (distance from pedestrian to intersection) < PED_DIST_TO_INTERSECTION
require ego.lane is adversary.lane

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in waymoTrajectory[-1] as egoReachedGoal
