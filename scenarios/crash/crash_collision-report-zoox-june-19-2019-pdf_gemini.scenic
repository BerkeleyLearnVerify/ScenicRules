"""
TITLE: collision-report-zoox-june-19-2019-pdf
DESCRIPTION: A Zoox vehicle, operating in manual mode, was traveling southbound on Mason Street at less than 3mph when a cyclist, traveling westbound on Sutter Street at a red light, cycled into the rear end of the Zoox vehicle. The incident occurred when the Zoox vehicle proceeded toward the intersection of Mason and Sutter, the cyclist entered Mason Street against the one-way onto the crosswalk to pass behind the Zoox vehicle. The cyclist then clipped the left rear side of the Zoox vehicle. After contact, the cyclist did not stop to exchange information and continued traveling westbound on Sutter Street.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

ZOOX_MODEL = 'vehicle.lincoln.mkz_2017'
BICYCLE_MODEL = 'vehicle.bh.crossbike'

param ZOOX_SPEED = VerifaiRange(3, 4) # less than 3mph = 4.8kmh
param CYCLIST_SPEED = VerifaiRange(5, 6.5)
param SAFETY_DIST = VerifaiRange(3, 5)
param EGO_BRAKE = VerifaiRange(0.5, 1.0)

EGO_INIT_DIST = [5, 15] # Distance from ego to intersection
ADV_INIT_DIST = [15, 20] # Distance from adversary to intersection

COLLISION_DIST = 2 # Distance for collision detection
TERM_DIST = 50 # Distance to terminate scenario if ego moves too far

#################################
# AGENT BEHAVIORS               #
#################################

behavior ZooxBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.ZOOX_SPEED, trajectory=trajectory)
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.EGO_BRAKE)

behavior CyclistBehavior():
    take SetWalkingDirectionAction(self.heading + 0.43) # Turn left onto Mason St.
    take SetWalkingSpeedAction(globalParameters.CYCLIST_SPEED)
    
    
    #do FollowTrajectoryBehavior(target_speed=globalParameters.CYCLIST_SPEED, trajectory=trajectory)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

# Zoox (Ego) - traveling southbound on Mason Street
# Choose an incoming lane that allows a straight maneuver through the intersection
egoInitLane = Uniform(*intersection.incomingLanes)
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoLeftManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, egoInitLane.maneuvers))
advSidewalk = egoLeftManeuver.endLane.group._opposite.sidewalk
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

# Cyclist (Adversary) - traveling westbound on Sutter Street, then enters Mason Street to pass behind Zoox
# Choose an incoming lane perpendicular to ego's initial lane.
# To position the cyclist to pass behind the southbound Zoox, a left turn from a westbound lane onto the southbound lane is suitable.


#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint ZOOX_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint ZOOX_MODEL,
        with behavior ZooxBehavior(egoTrajectory)

adversary = new Bicycle in advSidewalk,
    facing toward ego,
    with blueprint BICYCLE_MODEL,
    with behavior CyclistBehavior()

#################################
# REQUIREMENTS                  #
#################################

require EGO_INIT_DIST[0] <= (distance to intersection) <= EGO_INIT_DIST[1]
require ADV_INIT_DIST[0] <= (distance from adversary to intersection) <= ADV_INIT_DIST[1]

#terminate when (distance to adversary) < COLLISION_DIST
terminate when (distance to egoSpawnPt) > TERM_DIST

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal