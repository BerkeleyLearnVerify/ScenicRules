"""
TITLE: gm-cruise-collision-report-august-10-2019-pdf
DESCRIPTION: A Cruise autonomous vehicle (“Cruise AV”), operating in autonomous mode, was traveling northbound on Noe Street at the intersection with 14th Street when the Cruise AV yielded to a pedestrian in the north crosswalk. The driver of the Cruise AV disengaged from autonomous mode, and shortly thereafter, another vehicle attempting a left turn from southbound Noe onto eastbound 14th made contact with the left rear corner of the Cruise AV, damaging the Cruise AV’s left rear fascia and wheel well. There were no injuries reported at the scene by either party and police were not called.
SOURCE: California DMV Crash Reports
GENERATED BY: Gemini-2.5-Flash
"""

#################################
# MAP AND MODEL                 #
#################################

param map = localPath('../../maps/Town04.xodr')
model scenic.simulators.metadrive.model
param POLICY = 'built_in'

#################################
# CONSTANTS                     #
#################################

CRUISE_AV_MODEL = 'vehicle.lincoln.mkz_2017'
PEDESTRIAN_MODEL = 'vehicle.pedestrian.0001'
ADV_MODEL = 'vehicle.chevrolet.impala'

param EGO_SPEED = VerifaiRange(7, 10)
param EGO_BRAKE = VerifaiRange(0.5, 1.0)

param PED_SPEED = VerifaiRange(1, 2)

param ADV_SPEED = VerifaiRange(5, 7)

EGO_INIT_DIST = [0, 15]
ADV_INIT_DIST = [20, 30]
PED_INIT_DIST = [0, 5]
param PED_YIELD_DIST = VerifaiRange(9, 11)
param PED_ROTATION = VerifaiRange(1.2, 1.5)

param SAFETY_DIST = VerifaiRange(3, 5)
CRASH_DIST = 3
TERM_DIST = 70

#################################
# AGENT BEHAVIORS               #
#################################

behavior YieldToPedestrianBehavior():
    while True:
        take SetBrakeAction(1.0)
        take SetThrottleAction(0.0)

behavior WaitBehavior():
    while True:
        wait

behavior CrossBehavior():
    take SetWalkingDirectionAction(self.heading + globalParameters.PED_ROTATION)
    while True:
        take SetWalkingSpeedAction(globalParameters.PED_SPEED)

behavior EgoBehavior(trajectory):
    try:
        do FollowTrajectoryBehavior(target_speed=globalParameters.EGO_SPEED, trajectory=trajectory) until withinDistanceToAnyPedestrians(self, globalParameters.PED_YIELD_DIST)
        do YieldToPedestrianBehavior()
    interrupt when withinDistanceToAnyObjs(self, globalParameters.SAFETY_DIST):
        take SetBrakeAction(globalParameters.EGO_BRAKE)


behavior PedestrianBehavior():
    do WaitBehavior() until distance from self to ego < globalParameters.PED_YIELD_DIST + 3
    do CrossBehavior()

behavior AdversaryBehavior(trajectory):
    do FollowTrajectoryBehavior(target_speed=globalParameters.ADV_SPEED, trajectory=trajectory)

#################################
# SPATIAL RELATIONS             #
#################################

intersection = Uniform(*filter(lambda i: i.is4Way, network.intersections))

# Ego (Cruise AV) traveling northbound (straight)
egoInitLane = Uniform(*intersection.incomingLanes)
egoManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.STRAIGHT, egoInitLane.maneuvers))
egoTrajectory = [egoInitLane, egoManeuver.connectingLane, egoManeuver.endLane]
egoSpawnPt = new OrientedPoint in egoInitLane.centerline

# Adversary vehicle attempting a left turn from southbound
# Find the lane opposite to ego's straight path

advInitLane = egoManeuver.reverseManeuvers[0].startLane
# Find a left turn maneuver from this opposite lane
advManeuver = Uniform(*filter(lambda m: m.type is ManeuverType.LEFT_TURN, advInitLane.maneuvers))
advTrajectory = [advInitLane, advManeuver.connectingLane, advManeuver.endLane]
advSpawnPt = new OrientedPoint in advInitLane.centerline

# Pedestrian in the north crosswalk (crossing ego's path)
# Select a crosswalk at the intersection that connects to the lane ego will enter after crossing the intersection
egoLaneAfterIntersection = egoManeuver.endLane
pedSpawnPt = new OrientedPoint on egoLaneAfterIntersection.group.sidewalk

#################################
# SCENARIO SPECIFICATION        #
#################################

if globalParameters.POLICY == 'metadrive_ppo' or globalParameters.POLICY == 'ppo_with_built_in':
    from metadrive_expert import MetaDrivePPOPolicyCar, MetaDrivePPOPolicyBehavior, MetaDrivePPOUpdateState
    ego = new MetaDrivePPOPolicyCar at egoSpawnPt,
        with blueprint CRUISE_AV_MODEL,
        with behavior MetaDrivePPOPolicyBehavior(egoTrajectory)
    require monitor MetaDrivePPOUpdateState()
else:
    ego = new Car at egoSpawnPt,
        with blueprint CRUISE_AV_MODEL,
        with behavior EgoBehavior(egoTrajectory)

adversary = new Car at advSpawnPt,
    with blueprint ADV_MODEL,
    with behavior AdversaryBehavior(advTrajectory)

pedestrian = new Pedestrian at pedSpawnPt,
    with blueprint PEDESTRIAN_MODEL,
    with behavior PedestrianBehavior(),
    facing ego

#################################
# REQUIREMENTS                  #
#################################

require EGO_INIT_DIST[0] <= (distance to intersection) <= EGO_INIT_DIST[1]
require ADV_INIT_DIST[0] <= (distance from adversary to intersection) <= ADV_INIT_DIST[1]
require PED_INIT_DIST[0] <= (distance from pedestrian to intersection) <= PED_INIT_DIST[1]

from rulebook_benchmark import bench
require monitor bench.bench()
record ego in egoTrajectory[-1] as egoReachedGoal
